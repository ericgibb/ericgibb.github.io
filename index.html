<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 9</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(500, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {

    game.load.image('sky', 'assets/sky.png');
    game.load.image('ground', 'assets/platform.png');
    game.load.image('block', 'assets/block.png');
    game.load.image('duck', 'assets/duck.png');
    game.load.image('logo', 'assets/logo.png');
}

var ground;
var blocks;
var isHit = false;
var count = 0;
var blockSpeed = 400;
var blockSpeedIncrease = 20;
var score = 0;
var highScore = 0;

function create() {

    game.add.sprite(0, 0, 'sky');
    game.add.sprite(0, 0, 'logo');

    scoreText = game.add.text(50, 100, 'Score: 0', { font: "20px Arial", fill: "#e1d400", align: "left" });
    highScoreText = game.add.text(50, 150, 'High Score: 0', { font: "20px Arial", fill: "#e1d400", align: "left" });
  
    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);

    //  A simple background for our game

    // Here we create the ground.
    ground = game.add.sprite(100, game.world.height - 64, 'ground');
    game.physics.arcade.enable(ground);
    ground.body.immovable = true;
    // The player and its settings
    player = game.add.sprite(game.world.width/2, game.world.height - 150, 'duck');

    //  We need to enable physics on the player
    game.physics.arcade.enable(player);

    //  Player physics properties. Give the little guy a slight bounce.
    player.body.bounce.y = 0.25;
    player.body.gravity.y = 1500;
    // player.body.collideWorldBounds = false;
    player.checkWorldBounds = true;
    player.events.onOutOfBounds.add( killPlayer, this );

    
    //  Our controls.
    cursors = game.input.keyboard.createCursorKeys();
    
    
    addBlock();
  }

function update() {

    //  Collide the player and the stars with the platforms
    game.physics.arcade.collide(player, ground);
    if (!isHit) {
      game.physics.arcade.collide(player, blocks, hitBlock);
    }
    
    
    score += 1;
    scoreText.text = 'Score: ' + score;
    
    blocks.body.velocity.x = -(blockSpeed + (blockSpeedIncrease*count));
    
    //  Reset the players velocity (movement)
    player.body.velocity.x = 0;
    
    //  Allow the player to jump if they are touching the ground. 
    if (cursors.up.isDown && player.body.touching.down)
    {
        player.body.velocity.y = -500;
    }
    
    //  Allow the player to duck
    if (cursors.down.isDown && player.body.touching.down)
    {
      if (player.scale.y == 0.5) {
        // already crouched 
      }else{
        player.y += player.getBounds().height/2;
        player.scale.y = 0.5;
      }
    }else{
      if (player.scale.y == 1) {
        // already standing
      }else{
        player.y -= player.getBounds().height;
        player.scale.y = 1;
      }
      
    }

}
function killPlayer(obj){
  // console.log('resetting player')
  player.reset(game.world.width/2, game.world.height - 150);
  
  if (score > highScore) {
    highScore = score;
    highScoreText.text = "High Score: " + score;
  }
    score = 0;
    count = 0;
 
}

function addBlock(){
  // blocks
  blocks = game.add.sprite(200, 300 , 'block')
  game.physics.arcade.enable(blocks);
  blocks.body.immovable = true;  
  blocks.checkWorldBounds = true;
  blocks.events.onOutOfBounds.add( killBlock, this );
}

function killBlock(block){
//  console.log ('resetting block');
  block.reset(game.world.width - block.getBounds().width , game.world.height - (Math.random() > 0.5 ? 150 : 114));
  count += 1;
}

function hitBlock(){
  // console.log('hit a block')
  isHit = true;
  var v = {x: player.body.velocity.x, y: player.body.velocity.y};
  player.reset(player.x - player.getBounds().width, player.y)
  player.alpha = 0.2;
  player.body.velocity.set(v.x, v.y);
  setTimeout(function () {
    isHit = false;  
    player.alpha = 1;
    
  }, 500);
}

</script>

</body>
</html>